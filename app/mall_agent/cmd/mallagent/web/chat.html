<!DOCTYPE html>
<html>
<head>
    <title>Mall Agent 聊天</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        #chat-container { height: 400px; border: 1px solid #ccc; overflow-y: auto; padding: 10px; margin-bottom: 10px; }
        #user-input { width: 80%; padding: 8px; }
        button { padding: 8px 15px; }
    </style>
</head>
<body>
    <h1>Mall Agent 聊天</h1>
    <div id="chat-container"></div>
    <input type="text" id="user-input" placeholder="输入您的问题...">
    <button onclick="sendMessage()">发送</button>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const userId = 'web_user_' + Date.now();

        function addMessage(sender, message) {
            const messageDiv = document.createElement('div');
            messageDiv.innerHTML = `<strong>${sender}:</strong> ${message}`;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            addMessage('用户', message);
            userInput.value = '';

            // 添加一个占位符
            const placeholderDiv = document.createElement('div');
            placeholderDiv.innerHTML = '<strong>Mall Agent:</strong> <span id="response-placeholder">正在思考...</span>';
            chatContainer.appendChild(placeholderDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // 使用 EventSource 获取流式响应
            const eventSource = new EventSource(`/mall/stream?user_id=${userId}&query=${encodeURIComponent(message)}`);
            let fullResponse = '';
            
            eventSource.onmessage = function(event) {
                fullResponse += event.data;
                document.getElementById('response-placeholder').textContent = fullResponse;
                chatContainer.scrollTop = chatContainer.scrollHeight;
            };
            
            eventSource.onerror = function() {
                eventSource.close();
                if (!fullResponse) {
                    document.getElementById('response-placeholder').textContent = '发生错误，请重试';
                }
            };
        }

        // 按Enter键发送消息
        userInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>